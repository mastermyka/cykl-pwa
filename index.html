<!DOCTYPE html>
<html lang="pl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>TwÃ³j Cykl - Asystent Kobiecy Rozbudowany</title>
<link rel="manifest" href="manifest.json">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">
<meta name="mobile-web-app-capable" content="yes">
<style>
  body { font-family: 'Helvetica Neue', Arial, sans-serif; margin:0; background:#fafafa; color:#333; transition: background 0.3s, color 0.3s; }
  header { background: linear-gradient(90deg,#ff7a7a,#ff5e62); color:white; padding:1.5rem; text-align:center; }
  h1 { margin:0; font-size:1.6rem; }
  .container { padding:1rem; max-width:600px; margin:auto; }
  .card { background:white; border-radius:16px; box-shadow:0 2px 8px rgba(0,0,0,0.1); padding:1rem; margin-bottom:1rem; }
  .phase { padding:1rem; border-radius:12px; color:white; font-weight:bold; text-align:center; transition: background 0.3s; }
  .menstruacja { background:#ff4d6d; }
  .folikularna { background:#6fcf97; }
  .owulacja { background:#56ccf2; }
  .lutealna { background:#bb6bd9; }
  label { display:block; margin-top:0.5rem; font-weight:bold; }
  input { padding:0.5rem; width:100%; margin-top:0.25rem; border-radius:8px; border:1px solid #ddd; }
  button { padding:0.7rem 1.2rem; margin-top:1rem; background:#ff6f61; color:white; border:none; border-radius:10px; cursor:pointer; width:100%; font-weight:bold; }
  button:hover { background:#ff8a80; }
  table { width:100%; border-collapse:collapse; margin-top:0.5rem; }
  th, td { padding:0.5rem; border:1px solid #ddd; text-align:center; }
  th { background:#f0f0f0; }
  .calendar { display:grid; grid-template-columns: repeat(7, 1fr); gap:4px; margin-top:1rem; }
  .day { padding:8px; border-radius:8px; text-align:center; font-size:0.85rem; transition: background 0.3s; cursor:pointer; }
  .menstruacja-day { background:#ff4d6d; color:white; }
  .folikularna-day { background:#6fcf97; color:white; }
  .owulacja-day { background:#56ccf2; color:white; }
  .lutealna-day { background:#bb6bd9; color:white; }

  /* Cytat i Porada dnia */
  .daily-card { background: linear-gradient(135deg,#ff9a9e,#fad0c4); color:#fff; text-align:center; padding:2rem; font-size:1.1rem; line-height:1.5; margin-bottom:1rem; border-radius:16px; box-shadow:0 4px 12px rgba(0,0,0,0.1);}
  .daily-card p { margin:0.5rem 0; }
  .daily-card .quote { font-style:italic; font-size:1.2rem; }
  .daily-card .tip { font-weight:bold; font-size:1.1rem; }

  /* Akordeony */
  .accordion-btn { width: 100%; text-align: left; padding: 0.5rem 1rem; font-weight: bold;
                   background: linear-gradient(90deg, #ff7a7a, #ff5e62); color:white; border:none; border-radius:8px; margin-top:0.5rem; cursor:pointer; }
  .accordion-btn:hover { background: linear-gradient(90deg, #ff8a80, #ff6f61); }
  .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease; margin: 0.25rem 0 0 0; padding-left:1rem; list-style-type: disc; }
  .accordion-content.active { max-height: 500px; }

  /* Modal */
  #dayModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; justify-content:center; align-items:center; }
  #dayModal .modal-content { background:white; border-radius:16px; max-width:500px; width:90%; padding:1rem; position:relative; max-height:80vh; overflow-y:auto; }
  #closeModal { position:absolute; top:10px; right:10px; background:#ff6f61; color:white; border:none; border-radius:50%; width:30px; height:30px; cursor:pointer; }
.intimacy-tip {
  background: linear-gradient(135deg,#ff9a9e,#fad0c4);
  color: #fff;
  padding: 0.7rem 1rem;
  margin: 0.5rem 0;
  border-radius: 12px;
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
  font-size: 0.95rem;
}
  .calendar-nav button {
  background: linear-gradient(90deg, #ff7a7a, #ff5e62);
  color: white;
  border: none;
  border-radius: 8px;
  padding: 0.5rem 1rem;
  margin: 0.3rem;
  font-weight: bold;
  cursor: pointer;
}
.calendar-nav button:hover {
  background: linear-gradient(90deg, #ff8a80, #ff6f61);
}
.symptom-card {
  background: #fff5f5;
  border-left: 4px solid #ff5e62;
  padding: 0.5rem 1rem;
  margin-top: 0.5rem;
  border-radius: 8px;
  color: #333;
}

</style>
</head>
<body>
<header>
<h1>TwÃ³j Cykl - Asystent Kobiecy Rozbudowany</h1>
</header>
<div class="container">

<div class="card daily-card">
  <p class="quote" id="dailyQuote"></p>
  <p class="tip" id="dailyTip"></p>
</div>

<div class="card">
<h2>Aktualna faza cyklu</h2>
<div id="currentPhase" class="phase"></div>
<p><strong>DzieÅ„ cyklu:</strong> <span id="cycleDay"></span></p>
<p><strong>Owulacja:</strong> <span id="ovulationDate"></span></p>
<p><strong>Dni pÅ‚odne:</strong> <span id="fertileDays"></span></p>
<p><strong>NastÄ™pny okres:</strong> <span id="nextPeriod"></span></p>
</div>

<div class="card tips">
<h2>Rekomendacje</h2>
<p><strong>Menu dzienne:</strong></p>
<div id="foodAccordion"></div>
<p><strong>Wellness:</strong></p>
<div id="wellnessAccordion"></div>
<p><strong>IntymnoÅ›Ä‡:</strong></p>
<div id="intimacyAccordion"></div>
</div>

<div class="card">
  <h2 class="calendar-title">Kalendarz cyklu</h2>
  <div id="calendar" class="calendar"></div>
  <div class="calendar-nav" style="text-align:center; margin-top:10px;">
    <button onclick="showPreviousCycle()">â—€ Poprzedni cykl</button>
    <button onclick="showNextCycle()">NastÄ™pny cykl â–¶</button>
  </div>
</div>
<div class="card">
  <h2>Objawy dnia</h2>
  <label>BÃ³l brzucha:</label>
<input type="range" min="0" max="10" value="5" id="painLevel" oninput="painValue.textContent=this.value">
<div style="display:flex; justify-content:space-between; font-size:0.8rem;">
  <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span>
  <span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
</div>
<span id="painValue">5</span>

  
  <label>NastrÃ³j:</label>
<input type="range" min="0" max="10" value="5" id="moodLevel" oninput="moodValue.textContent=this.value">
<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:0.5rem;">
  <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span>
  <span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
</div>
<span id="moodValue">5</span>

  
  <label>Energia:</label>
<input type="range" min="0" max="10" value="5" id="energyLevel" oninput="energyValue.textContent=this.value">
<div style="display:flex; justify-content:space-between; font-size:0.8rem; margin-bottom:0.5rem;">
  <span>0</span><span>1</span><span>2</span><span>3</span><span>4</span>
  <span>5</span><span>6</span><span>7</span><span>8</span><span>9</span><span>10</span>
</div>
<span id="energyValue">5</span>
  
  <label>Inne objawy:</label>
  <textarea id="otherSymptoms" placeholder="np. bÃ³le gÅ‚owy, obrzmienie, sennoÅ›Ä‡..."></textarea>

  <button onclick="saveSymptoms()">Zapisz objawy</button>
</div>
<!-- Dodaj pod przyciskiem Zapisz objawy -->
<div style="overflow-x:auto; margin-top:10px;">
  <canvas id="symptomChart" style="height:220px;"></canvas>
</div>



<div class="card">
<h2>Historia cykli</h2>
<table>
<thead><tr><th>PoczÄ…tek</th><th>Koniec</th><th>DÅ‚ugoÅ›Ä‡</th><th>Akcja</th></tr></thead>
<tbody id="historyTable"></tbody>
</table>
</div>

<div class="card">
  <h2>ZarzÄ…dzanie okresem</h2>

  <label for="startDate">PoczÄ…tek okresu:</label>
  <input type="date" id="startDate">
  <button onclick="addPeriodStart()">Dodaj poczÄ…tek okresu</button>

  <label for="endDate">Koniec okresu:</label>
  <input type="date" id="endDate">
  <button onclick="addPeriodEnd()">ZakoÅ„cz bieÅ¼Ä…cy okres</button>
  <button 
  onclick="editLastPeriod()" 
  style="background:#ffa726;color:white;border:none;border-radius:10px;padding:0.7rem 1.2rem;margin-top:0.5rem;width:100%;font-weight:bold;">
  Edytuj bieÅ¼Ä…cy okres
</button>
</div>

<div class="card">
<h2>Eksport / Import historii</h2>
<button onclick="exportHistory()">Eksportuj JSON</button>
<input type="file" id="importFile" accept=".json">
<button onclick="importHistory()">Importuj JSON</button>
</div>

</div>

<div id="dayModal">
  <div class="modal-content">
    <button id="closeModal">âœ•</button>
    <h3 id="modalDate"></h3>
    <p id="modalPhase"></p>
    <div id="modalFood"></div>
    <div id="modalWellness"></div>
    <div id="modalSymptoms"></div>
    <div id="modalIntimacy"></div>
  </div>
</div>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// --- Dane i wczytywanie JSON ---
const periods = [
  { start: '2025-01-07', end: '2025-01-10' },
  { start: '2025-01-30', end: '2025-02-02' },
  { start: '2025-02-24', end: '2025-02-27' },
  { start: '2025-03-23', end: '2025-03-26' },
  { start: '2025-04-16', end: '2025-04-19' },
  { start: '2025-05-12', end: '2025-05-15' },
  { start: '2025-06-04', end: '2025-06-07' },
  { start: '2025-06-28', end: '2025-07-01' },
  { start: '2025-07-24', end: '2025-07-27' },
  { start: '2025-08-18', end: '2025-08-21' },
  { start: '2025-09-12', end: '2025-09-15' },
  { start: '2025-10-08', end: '2025-10-11' },
  { start: '2025-10-30', end: '2025-11-02' },
  { start: '2025-11-25', end: '2025-11-28' },
  { start: '2025-12-19', end: '2025-12-22' }
];
const tips = {
  menstruacja: { food:['Szpinak z jajkiem','SaÅ‚atka z burakami','Smoothie malinowe'], exercise:['Lekki spacer','RozciÄ…ganie'], mood:'ZmÄ™czenie' },
  folikularna: { food:['Jajka z warzywami','Owsianka','SaÅ‚atka z kurczakiem'], exercise:['Trening siÅ‚owy','Cardio'], mood:'DuÅ¼o energii' },
  owulacja: { food:['Owoce sezonowe','Orzechy','Smoothie jagodowe'], exercise:['Intensywny trening','Taniec'], mood:'PewnoÅ›Ä‡ siebie' },
  lutealna: { food:['Czekolada','Banany','Produkty bogate w magnez'], exercise:['Joga','Spacery'], mood:'Wahania nastroju' }
};

let quotesTipsData={}, foodData={}, wellnessData={}, intimacyData={};
fetch('quotesTips.json').then(r=>r.json()).then(d=>{ quotesTipsData=d; updateUI(); });
fetch('foodTips.json').then(r=>r.json()).then(d=>{ foodData=d; updateUI(); });
fetch('wellnessTips.json').then(r=>r.json()).then(d=>{ wellnessData=d; updateUI(); });
fetch('intimacyTips.json').then(r=>r.json()).then(d=>{ intimacyData=d; updateUI(); })
.catch(err=>console.error('Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ tipÃ³w intymnoÅ›ci:', err));

function parseDate(str){return new Date(str+'T00:00:00');}
function formatDate(d){
  const yyyy = d.getFullYear();
  const mm = String(d.getMonth() + 1).padStart(2,'0');
  const dd = String(d.getDate()).padStart(2,'0');
  return `${yyyy}-${mm}-${dd}`;
}


function calculateAverageCycle(periods){
  let total=0;
  for(let i=1;i<periods.length;i++){
    total += (parseDate(periods[i].start)-parseDate(periods[i-1].start))/(1000*60*60*24);
  }
  return Math.round(total/(periods.length-1));
}

function getCycleInfo(periods){
  const avgCycle = calculateAverageCycle(periods);
  const lastPeriod = parseDate(periods[periods.length - 1].start);
  const today = new Date();
  const dayOfCycle = Math.floor((today - lastPeriod) / (1000 * 60 * 60 * 24)) + 1;

  // Owulacja = 14 dni przed koÅ„cem cyklu
  const ovulationDay = avgCycle - 14;

  // Dni pÅ‚odne = 5 dni przed i 2 dni po owulacji
  const fertileStart = new Date(lastPeriod);
  fertileStart.setDate(fertileStart.getDate() + ovulationDay - 5);

  const fertileEnd = new Date(lastPeriod);
  fertileEnd.setDate(fertileEnd.getDate() + ovulationDay + 2);

  const ovulationDate = new Date(lastPeriod);
  ovulationDate.setDate(ovulationDate.getDate() + ovulationDay);

  const nextPeriod = new Date(lastPeriod);
  nextPeriod.setDate(nextPeriod.getDate() + avgCycle);

  // Faza cyklu (dla wyÅ›wietlania kolorÃ³w i rekomendacji)
  let phase = '', phaseClass = '';
  if (dayOfCycle <= 4) {
    phase = 'menstruacja'; phaseClass = 'menstruacja';
  } else if (dayOfCycle <= ovulationDay - 2) {
    phase = 'folikularna'; phaseClass = 'folikularna';
  } else if (dayOfCycle <= ovulationDay + 2) {
    phase = 'owulacja'; phaseClass = 'owulacja';
  } else {
    phase = 'lutealna'; phaseClass = 'lutealna';
  }

  return {
    phase,
    phaseClass,
    dayOfCycle,
    fertileDays: [formatDate(fertileStart), formatDate(fertileEnd)],
    ovulationDate: formatDate(ovulationDate),
    nextPeriod: formatDate(nextPeriod)
  };
}

// --- Losowe elementy ---
function getRandomItems(arr,n=1){ if(!arr || !arr.length) return []; return [...arr].sort(()=>0.5-Math.random()).slice(0,n); }

function createAccordion(containerId,data,randomize=false){
  const container=document.getElementById(containerId); container.innerHTML='';
  if(!data) return;
  if(Array.isArray(data)){
    const items = randomize ? getRandomItems(data,1) : data;
    const ul = document.createElement('ul'); ul.className='accordion-content active';
    ul.innerHTML = items.map(i=>`<li>${i}</li>`).join('');
    container.appendChild(ul);
    return;
  }
  for(const key in data){
    if(!Array.isArray(data[key])) continue;
    const items = randomize ? getRandomItems(data[key],1) : data[key];
    const div=document.createElement('div');
    div.innerHTML=`<button class="accordion-btn" onclick="this.nextElementSibling.classList.toggle('active')">${key}</button>
      <ul class="accordion-content">${items.map(i=>`<li>${i}</li>`).join('')}</ul>`;
    container.appendChild(div);
  }
}

// --- Aktualizacja UI ---
function updateUI(){
  const info=getCycleInfo(periods);
  const phaseDiv=document.getElementById('currentPhase');
  phaseDiv.textContent=info.phase.toUpperCase();
  phaseDiv.className=`phase ${info.phaseClass}`;

  document.getElementById('cycleDay').textContent=info.dayOfCycle;
  document.getElementById('ovulationDate').textContent=info.ovulationDate;
  document.getElementById('fertileDays').textContent=`${info.fertileDays[0]} - ${info.fertileDays[1]}`;
  document.getElementById('nextPeriod').textContent=info.nextPeriod;

  createAccordion('foodAccordion', foodData[info.phase], true);
  createAccordion('wellnessAccordion', wellnessData[info.phase], true);
  const intimacyTips = intimacyData[info.phase] || [];
const randomIntimacyTip = intimacyTips[Math.floor(Math.random() * intimacyTips.length)] || '';
document.getElementById('intimacyAccordion').innerHTML = `<div class="intimacy-tip">${randomIntimacyTip}</div>`;


  document.getElementById('dailyQuote').textContent=quotesTipsData[info.phase]?.quotes?.[Math.floor(Math.random()*(quotesTipsData[info.phase]?.quotes?.length||1))]||'';
  document.getElementById('dailyTip').textContent=quotesTipsData[info.phase]?.tips?.[Math.floor(Math.random()*(quotesTipsData[info.phase]?.tips?.length||1))]||'';

  updateHistory();
  updateCalendar();
  updateSymptomChart();
}
  function getCurrentPhaseClass() {
  const info = getCycleInfo(periods);
  return info.phase;
}
if (document.getElementById('dayModal').style.display === 'flex') {
  showDayModal(formatDate(new Date()), getCurrentPhaseClass());
}
let symptomChart; // zmienna globalna wykresu

function updateSymptomChart() {
  const dates = Object.keys(symptoms).sort();
  const labels = dates.map(d => {
    const dt = new Date(d);
    return `${dt.getDate()}.${dt.getMonth()+1}`; // np. "3.1"
  });

  const painData = dates.map(d => parseInt(symptoms[d].pain) || 0);
  const energyData = dates.map(d => parseInt(symptoms[d].energy) || 0);
  const moodData = dates.map(d => parseInt(symptoms[d].moodValue) || 0); // suwak nastroju

  const canvas = document.getElementById('symptomChart');
  // ustawiamy szerokoÅ›Ä‡: 30px na dzieÅ„, minimum 500px
  canvas.width = Math.max(dates.length * 30, 500);

  const ctx = canvas.getContext('2d');

  if(symptomChart) symptomChart.destroy(); // usuÅ„ poprzedni wykres

  symptomChart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: labels, // <-- tu musi byÄ‡ "labels", nie "dates"
      datasets: [
        {
          label: 'BÃ³l',
          data: painData,
          borderColor: '#ff4d6d',
          backgroundColor: 'rgba(255,77,109,0.2)',
          tension: 0.3,
          fill: true
        },
        {
          label: 'Energia',
          data: energyData,
          borderColor: '#56ccf2',
          backgroundColor: 'rgba(86,204,242,0.2)',
          tension: 0.3,
          fill: true
        },
        {
          label: 'NastrÃ³j',
          data: moodData,
          borderColor: '#4caf50',
          backgroundColor: 'rgba(76,175,80,0.2)',
          tension: 0.3,
          fill: true
        }
      ]
    },
    options: {
      responsive: false, // false, bo szerokoÅ›Ä‡ ustawiamy rÄ™cznie
      maintainAspectRatio: false,
      plugins: {
        legend: { display: true },
        tooltip: { enabled: false }
      },
      scales: {
        y: { min: 0, max: 10 }
      }
    }
  });
}




// --- Historia i kalendarz ---
function updateHistory() {
  const tbody = document.getElementById('historyTable');
  tbody.innerHTML = '';
  periods.forEach((p, i) => {
    let endDisplay = p.end ? p.end : '(trwa)';
    let len = p.end ? ((parseDate(p.end) - parseDate(p.start)) / (1000*60*60*24) + 1) : 'â€“';
    tbody.innerHTML += `
      <tr>
        <td>${p.start}</td>
        <td>${endDisplay}</td>
        <td>${len}</td>
        <td>
          <button 
            onclick="deletePeriod(${i})" 
            style="background:#ff4d6d;color:white;border:none;border-radius:6px;padding:4px 8px;cursor:pointer;">
            UsuÅ„
          </button>
        </td>
      </tr>`;
  });
}
  function deletePeriod(index) {
  if (!confirm('Na pewno chcesz usunÄ…Ä‡ ten okres?')) return;
  periods.splice(index, 1);
  saveHistory();
  updateUI();
  alert('Okres zostaÅ‚ usuniÄ™ty.');
}
let currentCycleIndex = periods.length - 1;

function showPreviousCycle() {
  if (currentCycleIndex > 0) {
    currentCycleIndex--;
    updateCalendar();
  }
}

function showNextCycle() {
  if (currentCycleIndex < periods.length - 1) {
    currentCycleIndex++;
    updateCalendar();
  }
}

function updateCalendar() {
  const calendar = document.getElementById('calendar');
  calendar.innerHTML = '';

  const avgCycle = calculateAverageCycle(periods);
  const period = periods[currentCycleIndex];
  const startDate = parseDate(period.start);

  // Oblicz prognozy faz cyklu
  const nextPeriod = new Date(startDate);
  nextPeriod.setDate(nextPeriod.getDate() + avgCycle);

  const ovulationDate = new Date(nextPeriod);
  ovulationDate.setDate(ovulationDate.getDate() - 14);

  const fertileStart = new Date(ovulationDate);
  fertileStart.setDate(fertileStart.getDate() - 5);

  const fertileEnd = new Date(ovulationDate);
  fertileEnd.setDate(fertileEnd.getDate() + 2);

  // zakres dni: aktualny cykl + tydzieÅ„ zapasu
  const totalDays = avgCycle + 7;

  for (let i = 0; i < totalDays; i++) {
    const day = new Date(startDate);
    day.setDate(day.getDate() + i);
    const dateStr = formatDate(day);

    let cls = '';

    // 1ï¸âƒ£ MiesiÄ…czka
    if (dateStr >= period.start && dateStr <= period.end) {
      cls = 'menstruacja-day';
    }
    // 2ï¸âƒ£ Dni pÅ‚odne (5 przed owulacjÄ… do 2 po)
    else if (dateStr >= formatDate(fertileStart) && dateStr <= formatDate(fertileEnd)) {
      cls = 'folikularna-day';
    }
    // 3ï¸âƒ£ DzieÅ„ owulacji
    else if (dateStr === formatDate(ovulationDate)) {
      cls = 'owulacja-day';
    }
    // 4ï¸âƒ£ Lutealna (po owulacji do nastÄ™pnej miesiÄ…czki)
    else {
      cls = 'lutealna-day';
    }

    calendar.innerHTML += `
      <div class='day ${cls}' title='${dateStr}' onclick='showDayModal("${dateStr}", "${cls}")'>
        ${day.getDate()}
        ${dateStr === formatDate(ovulationDate) ? "<div style='font-size:0.6rem;'>ðŸ’§</div>" : ""}
      </div>`;
  }

  // ðŸ”¹ ZmieÅ„ tylko tytuÅ‚ kalendarza (nie innych kart)
  const title = document.querySelector(".calendar-title");
  if (title) {
    title.textContent = "Kalendarz cyklu: " + (currentCycleIndex + 1) + " z " + periods.length;
  }
}

function showDayModal(date, phaseClass) {
  let phase = '';
  if (phaseClass.includes('menstruacja')) phase = 'menstruacja';
  else if (phaseClass.includes('folikularna')) phase = 'folikularna';
  else if (phaseClass.includes('owulacja')) phase = 'owulacja';
  else phase = 'lutealna';

  const modal = document.getElementById('dayModal');
  document.getElementById('modalDate').textContent = date;
  document.getElementById('modalPhase').textContent = 'Faza: ' + phase.toUpperCase();

  // Akordeony
  createAccordion('modalFood', foodData[phase], true);
  createAccordion('modalWellness', wellnessData[phase], true);

  // Objawy dnia
  const symptomsContainer = document.getElementById('modalSymptoms');
  symptomsContainer.innerHTML = ''; // wyczyÅ›Ä‡ poprzednie
  const symptom = symptoms[date];
  if (symptom) {
    symptomsContainer.innerHTML = `
      <div class="symptom-card">
        <h4>Objawy zapisane:</h4>
        <p><strong>BÃ³l:</strong> ${symptom.pain}/10</p>
        <p><strong>NastrÃ³j:</strong> ${symptom.mood}</p>
        <p><strong>Energia:</strong> ${symptom.energy}/10</p>
        <p><strong>Inne:</strong> ${symptom.other || 'â€”'}</p>
      </div>`;
  } else {
    symptomsContainer.innerHTML = `<p>Brak zapisanych objawÃ³w.</p>`;
  }

  // IntymnoÅ›Ä‡
  const modalIntimacyTips = intimacyData[phase] || [];
  const randomModalIntimacyTip = modalIntimacyTips[Math.floor(Math.random() * modalIntimacyTips.length)] || '';
  document.getElementById('modalIntimacy').innerHTML = `<div class="intimacy-tip">${randomModalIntimacyTip}</div>`;

  modal.style.display = 'flex';
}


document.getElementById('closeModal').addEventListener('click',()=>{document.getElementById('dayModal').style.display='none';});

// --- Dodawanie i LocalStorage ---
function saveHistory(){ localStorage.setItem('cycleHistory',JSON.stringify(periods)); }
function loadHistory(){
  const data=localStorage.getItem('cycleHistory');
  if(data){ try{ const arr=JSON.parse(data); if(Array.isArray(arr)) periods.splice(0,periods.length,...arr); }catch(e){console.error(e);} }
}

function addPeriod(){
  const start=document.getElementById('startDate').value;
  const end=document.getElementById('endDate').value;
  if(start && end){ periods.push({start,end}); saveHistory(); updateUI(); alert('Dodano okres!'); }
  else alert('WprowadÅº obie daty.');
}
  function addPeriod(){
  const start=document.getElementById('startDate').value;
  const end=document.getElementById('endDate').value;
  if(start && end){ 
    periods.push({start,end}); 
    saveHistory(); 
    updateUI(); 
    alert('Dodano okres!'); 
  } else alert('WprowadÅº obie daty.');
}
function editLastPeriod() {
  if (periods.length === 0) {
    alert('Brak okresÃ³w do edycji.');
    return;
  }

  const last = periods[periods.length - 1];
  const newStart = prompt('Nowa data poczÄ…tku (RRRR-MM-DD):', last.start || '');
  if (!newStart) return;

  const newEnd = prompt('Nowa data koÅ„ca (RRRR-MM-DD lub zostaw puste jeÅ›li trwa):', last.end || '');
  
  // Walidacja prostych dat
  if (newEnd && new Date(newEnd) < new Date(newStart)) {
    alert('Data koÅ„ca nie moÅ¼e byÄ‡ wczeÅ›niejsza niÅ¼ poczÄ…tek.');
    return;
  }

  last.start = newStart;
  last.end = newEnd || null;

  saveHistory();
  updateUI();
  alert('Zaktualizowano bieÅ¼Ä…cy okres.');
}
// --- Nowe funkcje: dodawanie poczÄ…tku i koÅ„ca osobno ---
function addPeriodStart() {
  const start = document.getElementById('startDate').value;
  if (!start) return alert('Podaj datÄ™ poczÄ…tku okresu!');
  
  // SprawdÅº, czy ostatni okres nie jest juÅ¼ otwarty
  const last = periods[periods.length - 1];
  if (last && !last.end) return alert('Najpierw zakoÅ„cz poprzedni okres!');
  
  periods.push({ start, end: null });
  saveHistory();
  updateUI();
  alert('Dodano poczÄ…tek okresu!');
}

function addPeriodEnd() {
  const end = document.getElementById('endDate').value;
  if (!end) return alert('Podaj datÄ™ zakoÅ„czenia okresu!');
  
  const last = periods[periods.length - 1];
  if (!last || last.end) return alert('Brak rozpoczÄ™tego okresu do zakoÅ„czenia!');
  
  last.end = end;
  saveHistory();
  updateUI();
  alert('ZakoÅ„czono bieÅ¼Ä…cy okres!');
}

// --- Objawy dnia ---
let symptoms = JSON.parse(localStorage.getItem('symptoms')) || {};
function saveSymptoms(){
  const date = formatDate(new Date());
  symptoms[date] = {
    pain: document.getElementById('painLevel').value,
    energy: document.getElementById('energyLevel').value,
    moodValue: document.getElementById('moodLevel').value, // wartoÅ›Ä‡ liczbowo dla wykresu
    mood: ["ZÅ‚y","Neutralny","Dobry"][Math.round(document.getElementById('moodLevel').value/5)], // opcjonalnie tekst
    other: document.getElementById('otherSymptoms').value
  };
  localStorage.setItem('symptoms', JSON.stringify(symptoms));
  alert('Zapisano objawy dnia!');
  updateSymptomChart();
}


// --- Eksport / Import JSON ---
function exportHistory(){
  const dataStr = JSON.stringify(periods,null,2);
  const blob = new Blob([dataStr],{type:"application/json"});
  const url = URL.createObjectURL(blob);
  const a=document.createElement('a'); a.href=url; a.download='cycleHistory.json'; a.click();
  URL.revokeObjectURL(url);
}
function importHistory(){
  const file=document.getElementById('importFile').files[0];
  if(!file) return alert('Wybierz plik JSON!');
  const reader=new FileReader();
  reader.onload=e=>{
    try{
      const arr=JSON.parse(e.target.result);
      if(Array.isArray(arr)){ periods.splice(0,periods.length,...arr); saveHistory(); updateUI(); alert('Historia zaimportowana!'); }
      else alert('Niepoprawny format JSON!');
    }catch(err){ alert('BÅ‚Ä…d parsowania JSON'); }
  };
  reader.readAsText(file);
}

// --- Service Worker ---
if('serviceWorker' in navigator){
  navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW zarejestrowany'));
}

// --- Start ---
loadHistory();
updateUI();

// --- Funkcja downloadICSWithAlert ---
function downloadICSWithAlert(eventTitle, eventDate) {
  // Konwertujemy datÄ™
  const dt = new Date(eventDate);
  const yyyy = dt.getFullYear();
  const mm = String(dt.getMonth() + 1).padStart(2,'0');
  const dd = String(dt.getDate()).padStart(2,'0');
  const dtStart = `${yyyy}${mm}${dd}`;

  const icsContent = `
BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//TwÃ³jCykl//PWA//PL
BEGIN:VEVENT
UID:${Date.now()}@twojcykl
DTSTAMP:${dtStart}T080000Z
DTSTART;VALUE=DATE:${dtStart}
DTEND;VALUE=DATE:${dtStart}
SUMMARY:${eventTitle}
DESCRIPTION:Przypomnienie z aplikacji TwÃ³j Cykl
BEGIN:VALARM
TRIGGER:-P1D
ACTION:DISPLAY
DESCRIPTION:Przypomnienie: ${eventTitle}
END:VALARM
END:VEVENT
END:VCALENDAR
  `.trim();

  const blob = new Blob([icsContent], { type: 'text/calendar' });
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `${eventTitle.replace(/\s/g,'_')}_${dtStart}.ics`;
  a.click();
  URL.revokeObjectURL(url);
}

// --- Tworzenie karty z przyciskami ICS w stylu UI ---
const info = getCycleInfo(periods);

const icsCard = document.createElement('div');
icsCard.className = 'card';
icsCard.innerHTML = `
  <h2>Przypomnienia w Kalendarzu</h2>
  <button class="ics-btn" onclick="downloadICSWithAlert('NadchodzÄ…cy okres', '${info.nextPeriod}')">Dodaj przypomnienie okresu</button>
  <button class="ics-btn" onclick="downloadICSWithAlert('Owulacja', '${info.ovulationDate}')">Dodaj przypomnienie owulacji</button>
`;

document.querySelector('.container').appendChild(icsCard);

// --- Styl przyciskÃ³w ICS ---
const style = document.createElement('style');
style.textContent = `
  .ics-btn {
    display:block;
    width:100%;
    padding:0.7rem 1.2rem;
    margin:0.5rem 0;
    background: linear-gradient(90deg, #ff7a7a, #ff5e62);
    color:white;
    border:none;
    border-radius:10px;
    font-weight:bold;
    cursor:pointer;
    transition: background 0.3s;
  }
  .ics-btn:hover {
    background: linear-gradient(90deg, #ff8a80, #ff6f61);
  }
`;
document.head.appendChild(style);

</script>
</body>
</html>
